---
title: "Estimating reproduction number and burden of Dengue"
author: "Lorenzo Cattarino"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating reproduction number and burden of Dengue}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Background

Accurate estimates of transmission intensity of Dengue are needed to quantify the global burden of the disease and assess the impact of control strategies. Transmission intensity is often measured using the force of infection (the per capita rate at which susceptible individuals acquire infection, **$\lambda$**) or the basic reproduction number (the average number of secondary infections generated by one primary case entering a susceptible population, **R~0~**). Although they measure different things, **$\lambda$** and **R~0~** are related through the age structure of the population affected by the disease. This package provides a set of functions to translate force of infection into reproduction number and to quantify number of infections and symptomatic cases. We make a number of assumptions: 

1. Dengue transmission is at equilibrium 
2. There is a maxiumum number of four dengue infections per individual
3. Force of infection is constant through time
4. Four dengue serotypes in circulation 

<br>

# Getting started

## Installation

You can install the development version of the package using `devtools`. First install `devtools`, if you don't already have it

```{r include = TRUE, eval = FALSE}
install.packages("devtools")
library(devtools)
```

Then, in a fresh R session, install the `drep` package

```{r include = TRUE, eval = FALSE}
devtools::install_github("mrc-ide/drep", ref = "mrc-branch")
library(drep)
```

We will start with a simple example. The `foi` dataset contains force of infection estimates for different locations in the world. Load the dataset with

```{r include = TRUE}
foi <- read.csv("foi.csv", stringsAsFactors = FALSE)
```

The dataset contains nine variables:

* `data_id` is an integer which represents the data point unique identifier 
* `type` is a character string describing wheather the data was collected through a serology study (`serology`) or a case surveillance system (`caseReport`).
* `longitude` and `latitude` are the numeric geographic coordinates of the data points.
* `ISO` is a character string describing the ISO **3166-1 alpha-3** country code.
* `ID_0` and `ID_1` are integers representing the GADM administrative units unique identifiers [http://gadm.org/]. 
* `FOI` is the force of infection estimate
* `population` is the Level 1 administrative unit population according to 2015 Landscan data [http://web.ornl.gov/sci/landscan/]

<br>

```{r, echo = FALSE, results = 'asis'}
knitr::kable(head(foi, 10), row.names = FALSE)
```

<br>

For the purpose of this example, we pick the fourth data point, i.e. a `caseReport` estimate from Brazil

```{r}
one_foi <- foi[4, "FOI"] # a point from Brazil
```

To be able to convert force of infection into reproduction number, we are also going to need information on the demographic structure of the population to which `FOI` refers. We will use country-level demographic information, , as reported by the United Nation Department of Economic and Social Affairs. The `age_structure` data set contains the proportion of individuals in 20 5-year age groups (0-99) in 2015 Load the dataset. The other important variable is `ID_0`, which represents the country unique identifier.

```{r include = TRUE}
age_structure <- read.csv("age_structure.csv", stringsAsFactors = FALSE)
```

The `age_structure` dataset looks like this:

```{r, echo = FALSE, results = 'asis'}
knitr::kable(head(age_structure, 10), row.names = FALSE)
```

<br>

You need the `ID_0` of the selected point (`one_foi`) from the `foi` dataset to be able to look up the correct demographic structure from the `age_structure` dataset. The `population` of the data point will also be needed to convert *proportions* to *numbers* 

```{r include = TRUE, eval = FALSE}
FOI_id0 <- foi[4, "ID_0"]
pop <- foi[4, "population"]
```

Now you can extract the country age structure 

```{r include = TRUE, eval = FALSE}
n_j <- age_structure[age_structure$ID_0 == FOI_id0, 2:ncol(age_structure)]
```

Last thing to do is to define the limits fo the age groups of the demographic data. The `l_lim` and `u_lim` objects are two vectors of the lower and upper age limits of each of the 20 age groups defining the country demographic structure 

```{r include = TRUE, eval = FALSE}
l_lim <- seq.int(0, 95, 5)
u_lim <- seq.int(5, 100, 5)
```

Now you have all the information you need to compute the **R~0~** from the given force of infection (**$\lambda$**). First, calculate the incidence of primary, secondary, tertiary and quaternary dengue infections in the population. *Incidence* is the probability that someone has a primary (or secondary, etc..) dengue infection in a particular age group.

```{r, include = TRUE, eval = FALSE}
incidences <- calculate_incidences(one_foi, l_lim, u_lim)
```

infs <- calculate_infections(incids, n_j, pop)
R0 <- calculate_R0(FOI, pop, infs, phis)
R0
