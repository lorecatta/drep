---
title: "Estimating reproduction number and burden of Dengue"
author: "Lorenzo Cattarino"
date: "`r Sys.Date()`"
output: 
  html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Estimating reproduction number and burden of Dengue}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette explains the key steps to compute reproduction number, number of infections and symptomatic cases of dengue from a force of infection estimate.  

# Background 

Accurate estimates of transmission intensity of Dengue are needed to quantify the global burden of the disease and assess the impact of control strategies. Transmission intensity is often measured using the force of infection (the per capita rate at which susceptible individuals acquire infection, **$\lambda$**) or the basic reproduction number (the average number of secondary infections generated by one primary case entering a susceptible population, **R~0~**). Although they measure different things, **$\lambda$** and **R~0~** are related through the age structure of the population affected by the disease. This package provides a set of functions to translate force of infection into reproduction number and to quantify number of infections and symptomatic cases. We make a number of assumptions: 

1. Dengue transmission is at equilibrium 
2. There is a maxiumum number of four dengue infections per individual
3. Force of infection is constant through time
4. Four dengue serotypes in circulation 

<br>

# Installation

You can install the development version of the package using `devtools`. First install `devtools`, if you don't already have it.

```{r include = TRUE, eval = FALSE}
install.packages("devtools")
library(devtools)
```

Then, in a fresh R session, install the `drep` package.

```{r include = TRUE, eval = FALSE}
devtools::install_github("mrc-ide/drep")
library(drep)
```

<br>

# Simulated data 

To convert Force of Infection into R_0 we need:

* the age structure of the human population 
* the relative infectiousness of the four dengue infections. 


We assume that the population is divided up into 20 age groups. We then define the following parameters:

1.`l_lim` and `u_lim` are numeric vectors representing lower and upper age limits of each of the 20 age groups defining the country demographic structure.  

2. `phis` is the numeric vector of the infectiousness of primary, secondary and tertiary dengue infections. Quaternary infections are assumed to have the same infectiousness as tertiary infections. 

```{r}
l_lim <- seq(0, 95, 5)
u_lim <- seq(5, 100, 5)
phis <- c(1, 1, 1, 1)
```



# Datasets

The `foi` dataset contains force of infection estimates for different locations in the world.

```{r include = FALSE}
foi <- read.csv("foi.csv", stringsAsFactors = FALSE)
```

```{r, echo = FALSE, results = 'asis'}
knitr::kable(head(foi, 10), row.names = FALSE)
```

<br>

The dataset contains nine variables.

* `data_id` is an integer which represents the data point unique identifier 
* `type` is a character string describing wheather the data was collected through a serology study (`serology`) or a case surveillance system (`caseReport`).
* `longitude` and `latitude` are the numeric geographic coordinates of the data points.
* `ISO` is a character string describing the ISO **3166-1 alpha-3** country code.
* `ID_0` and `ID_1` are integers representing the GADM administrative units unique identifiers [http://gadm.org/]. 
* `FOI` is the force of infection estimate
* `population` is the Level 1 administrative unit population according to 2015 Landscan data [http://web.ornl.gov/sci/landscan/]

Information on the demographic structure of the population to which the original force of infection estimate refers is needed to convert force of infection into reproduction number. The `age_structure` dataset contains the country-level proportion of individuals in 20 5-year age groups (0-99) from 2015, sourced from the United Nation Department of Economic and Social Affairs. Each age group proportion is a different variable. The other important variable is `ID_0`, which represents the country unique identifier. 

```{r, include = FALSE}
age_structure <- read.csv("age_structure.csv", stringsAsFactors = FALSE)
```

```{r, echo = FALSE, results = 'asis'}
knitr::kable(head(age_structure, 10), row.names = FALSE)
```

<br>

# Work flow

For the purpose of this example, we pick the fourth data point, i.e. a `caseReport` estimate from Brazil.

```{r}
lambda <- foi[4, "FOI"] # a point from Brazil
```

The `ID_0` of the point selected from the `foi` dataset (`lambda`) is needed to be able to look up the correct demographic structure from the `age_structure` dataset. The `population` of the data point will also be needed when calculating the **R~0~**. 

```{r}
id_0 <- foi[4, "ID_0"]
pop_size <- foi[4, "population"]
```

Look up the country age structure. 

```{r}
n_j <- age_structure[age_structure$ID_0 == id_0, 2:ncol(age_structure)]
```

The limits of the age groups of the demographic data are defined in `l_lim` and `u_lim` objects. These are two vectors of the lower and upper age limits of each of the 20 age groups defining the country demographic structure. 

```{r}
l_lim <- seq.int(0, 95, 5)
u_lim <- seq.int(5, 100, 5)
```

While the package assumed that all four dengue serotypes are in circulation, **R~0~** calculation depends on the relative infectiousness of each dengue infection, defined in the object `phis` (below). As a starting point, each infection is assumed to be equally infectious.  

```{r}
phis <- rep(1, times = 4)
```

Now to compute the **R~0~** from a given force of infection (**$\lambda$**), first calculate the incidence of primary, secondary, tertiary and quaternary dengue infections in the population using the `calculate_incidences()` function. Here *incidence* is the probability that someone has a primary (or secondary, etc..) dengue infection in a particular age group. The `calculate_incidences()` function takes three arguments:

* `FOI`: the force of infection estimate
* `l_lim`: the lower limits of the age groups
* `u_lim`: the upper limits of the age groups

```{r, include = FALSE}
calculate_incidences <- function(FOI, u_lim, l_lim) {

  get_incidences <- function(infec_prob) {

    (infec_prob / 4) / (u_lim - l_lim)

  }

  p_I1 <- exp(-4 * FOI * l_lim) - exp(-4 * FOI * u_lim)

  p_I2 <- 4 * (exp(-3 * FOI * l_lim) - exp(-3 * FOI * u_lim)) -
          3 * (exp(-4 * FOI * l_lim) - exp(-4 * FOI * u_lim))

  p_I3 <- 6 * (exp(-2 * FOI * l_lim) - exp(-2 * FOI * u_lim)) +
          8 * (exp(-3 * FOI * u_lim) - exp(-3 * FOI * l_lim)) +
          3 * (exp(-4 * FOI * l_lim) - exp(-4 * FOI * u_lim))

  p_I4 <- 4 * (exp(-FOI * l_lim) - exp(-FOI * u_lim) +
               exp(-3 * FOI * l_lim) - exp(-3 * FOI * u_lim)) +
          6 * (exp(-2 * FOI * u_lim) - exp(-2 * FOI * l_lim)) +
              (exp(-4 * FOI * u_lim) - exp(-4 * FOI * l_lim))

  all_probs <- list(p_I1, p_I2, p_I3, p_I4)

  lapply(all_probs, get_incidences)

}
incidences_to_numbers <- function(incidences, n_j, N) {

  ret <- incidences * n_j * N * 4

  sum(ret)

}
calculate_R0 <- function(FOI, N, infections, phis) {

  FOI * N * 4 / (sum(infections * phis))

}
calculate_cases <- function(incidences, sym_to_asym_ratios, n_j, N) {

  ret <- Map("*", incidences, sym_to_asym_ratios)

  vapply(ret, incidences_to_numbers, numeric(1), n_j, N)

}
```

```{r}
incidences <- calculate_incidences(lambda, l_lim, u_lim)
```

Then you can calculate the number of individuals with their primary, secondary, tertiary and quaternary infections in the population. The `incidences_to_numbers()` convert *rates* (i.e. incidences) into *total* numbers function takes three arguments

* `incidences`: is the incidence of primary, secondary, tertiary and quaternary dengue infections in the population.
* `n_j`: is the population age structure.
* `pop`: is the population size.

`vapply` is used here to apply the `incidence_to_numbers()` function onto each element of `incidence` 

```{r}
infections <- vapply(incidences, incidences_to_numbers, numeric(1), n_j, pop_size)
```

Finally, the **R~0~** can be computed using the `calculate_R0()` function, which takes four arguments the original force of infection estimate (`lambda`), population size (`pop_size`), number of primary, secondary, tertiary and quaternary infections (`infections`). The last argument of the function (`phis`) is the relative infectiousness of each dengue infection. 

```{r}
R0 <- calculate_R0(lambda, pop_size, infections, phis)
```

```{r}
R0
```
