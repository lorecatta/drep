---
title: "drep_examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{drep_examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(drep)
library(kableExtra)
```

# Introduction

This vignette explains the key steps to compute reproduction number, number of infections and symptomatic cases of dengue from a force of infection estimate.  

# Background 

Accurate estimates of transmission intensity of Dengue are needed to quantify the global burden of the disease and assess the impact of control strategies. Transmission intensity is often measured using the Force of Infection (the per capita rate at which susceptible individuals acquire infection, **$\lambda$**) or the basic reproduction number (the average number of secondary infections generated by one primary case entering a susceptible population, $R_0$). Although they measure different things, **$\lambda$** and $R_0$ are related through the age structure of the population affected by the disease. This package provides a set of functions to translate average force of infection (per serotype) into reproduction number and to quantify number of infections and symptomatic cases. We make a number of assumptions: 

1. Dengue transmission is at equilibrium 
2. There is a maxiumum number of four dengue infections per individual
3. Force of infection is constant through time
4. Four dengue serotypes in circulation 

<br>

# Installation

You can install the development version of the package using `devtools`. First install `devtools`, if you don't already have it.

```{r include = TRUE, eval = FALSE}
install.packages("devtools")
library(devtools)
```

Then, in a fresh R session, install the `drep` package.

```{r include = TRUE, eval = FALSE}
devtools::install_github("mrc-ide/drep")
library(drep)
```

<br>

# Simulated data example

To convert Force of Infection into R_0 we need:

* the age structure of the human population 
* the relative infectiousness of the four dengue infections. 

We assume that the population is divided up into 20 age groups. We define the following information:

* number of age groups in the country human population (`n_age_groups`)
* total human population of the country (`pop`)
* the Force of Infection estimate (`FOI`)
* the relative infectiousness of the four dengue infections (`phis`) 

We asssume, as a starting point, that all four infections have the same infectiousness. 

```{r}
n_age_groups <- 20
pop <- 500000
FOI <- 0.0235
phis <- c(1, 1, 1, 1)
```

We then Simulate some data, including

* the lower and upper age limits (`l_lim` and `u_lim`) of the country age groups 
* the number of individuals in each age group (`n_j`) 
* the proportion of individuals in each age gorup (`f_j`)

```{r}
l_lim <- seq(0, 95, length.out = n_age_groups)
u_lim <- seq(5, 100, length.out = n_age_groups)
n_j <- sample(1:50, n_age_groups, replace = TRUE)
f_j <- n_j / sum(n_j)
```

The $R_0$ can be calculated using the `calculate_R0` function. The `calculate_R0` function takes six arguments:

* `FOI`: a numeric value of the force of infection estimate, which represents the average estimate per serotype
* `pop`: a numeric value representing the total human population of the country
* `f_j`: a numeric vector of the proportions of individuals in each age gorup
* `l_lim`: a numeric vector of the lower limits of the country age groups
* `u_lim`: a numeric vector of the upper limits of the age groups
* `phis`: a numeric vector of the relative infectiousness of primary, secondary, tertiary and quaternary dengue infections. 

```{r}
R0 <- calculate_R0(FOI, pop, f_j, u_lim, l_lim, phis)
R0
```

<br>

# Real data example

Let's now use some real data. The `foi` dataset contains force of infection estimates for different locations in the world.

```{r, echo = FALSE, results = 'asis'}
knitr::kable(head(foi, 10), row.names = FALSE)
```

<br>

The dataset contains nine variables.

* `data_id` is an integer which represents the data point unique identifier 
* `type` is a character string describing wheather the data was collected through a serology study (`serology`) or a case surveillance system (`caseReport`).
* `longitude` and `latitude` are the numeric geographic coordinates of the data points.
* `ISO` is a character string describing the ISO **3166-1 alpha-3** country code.
* `ID_0` and `ID_1` are integers representing the GADM administrative units unique identifiers [http://gadm.org/]. 
* `FOI` is the force of infection estimate
* `population` is the Level 1 administrative unit population according to 2015 Landscan data [http://web.ornl.gov/sci/landscan/]

Information on the demographic structure of the population to which the original force of infection estimate refers is needed to convert force of infection into reproduction number. The `age_structure` dataset contains the country-level proportion of individuals in 20 5-year age groups (0-99) from 2015, sourced from the United Nation Department of Economic and Social Affairs. Each age group proportion is a different variable. The other important variable is `ID_0`, which represents the country unique identifier. 

```{r, echo = FALSE, results = 'asis'}
kableExtra::kable(head(age_structure, 10)) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
#knitr::kable(head(age_structure, 10), row.names = FALSE)
```

For the purpose of this example, we pick the fourth data point, i.e. a `caseReport` estimate from Brazil.

```{r}
lambda <- foi[4, "FOI"] # a point from Brazil
```

The `ID_0` of the point selected from the `foi` dataset (`lambda`) is needed to be able to look up the correct demographic structure from the `age_structure` dataset. The `population` of the data point will also be needed when calculating the $R_0$. 

```{r}
id_0 <- foi[4, "ID_0"]
pop_size <- foi[4, "population"]
```

Look up the country age structure. 

```{r}
n_j <- age_structure[age_structure$ID_0 == id_0, 2:ncol(age_structure)]
```

Now we compute the $R_0$ as before:

```{r}
R0 <- calculate_R0(FOI, pop, f_j, u_lim, l_lim, phis)
R0
```

Now we assume that only primary and secondary infections are infectious and therefore contribute to transmission. This implies that if a tertiary or a secondary infections are not infectious.

```{r}
phis <- c(1, 1, 0, 0)

R0 <- calculate_R0(FOI, pop, n_j, u_lim, l_lim, phis)
R0
```

The $R_0$ value increases relative to when using same weights because the virus has only two attempts at generating a given force of infection, so it has to have a higher $R_0$.

Finally let's assume that all four infections are infectious but symptomatic infections are twice as infectious as asymptomatic ones. This requires knowledge of the proportion of primary. secondary, tertiary and quaternary infections which are asymptomatic. We source the values of these parameters from [Ferguson et al. 2016](https://science.sciencemag.org/content/353/6303/1033) and put them in a vector.

```{r} 
prop_sym_parms <- c(0.45, 0.85, 0.15, 0.15)
```

We can use the function `calculate_infectiousness_sym_2x_asym` to calculate the relative infectiousness of the four dengue infections from the proportion of primary. secondary, tertiary and quaternary infectionsa which are asymptomatic.

```{r}
phis <- calculate_infectiousness_sym_2x_asym(prop_sym_parms)

R0 <- calculate_R0(FOI, pop, n_j, u_lim, l_lim, phis)
R0
```
